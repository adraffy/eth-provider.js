function e(e){let t;if("string"==typeof e?t=parseInt(e):"number"==typeof e&&(t=e),!Number.isSafeInteger(t))throw new TypeError(`Invalid chain: ${e}`);return`0x${t.toString(16)}`}class t{constructor(e){this._id=e,this.data=void 0}get id(){return this._id}get name(){return this.data?.name??`Chain(${this.id})`}explorer_address_uri(e){return this.data?.explore_address.replace("{}",e)}explorer_tx_uri(e){return this.data?.explore_tx.replace("{}",e)}toJSON(){return this.id}toString(){return`Chain(${this.id})`}}const r={};function i(i,s=!1){if(i instanceof t)return i;let n=e(i),o=r[n];if(!o&&s)throw new Error(`Unknown chain: ${n}`);return o}function s(){return Object.values(r)}function n(i){if(i instanceof t)return i;let s=e(i),n=r[s];return n||(n=r[s]=new t(s)),n}function o(e){return{explore_base:e,explore_address:`${e}/address/{}`,explore_tx:`${e}/tx/{}`}}function h(e){return-32e3===e.code&&"header not found"===e.message}n(1).data={name:"Mainnet",...o("https://etherscan.io")},n(3).data={name:"Ropsten",...o("https://ropsten.etherscan.io"),testnet:!0},n(4).data={name:"Rinkeby",...o("https://rinkeby.etherscan.io"),testnet:!0},n(5).data={name:"Goerli",...o("https://goerli.etherscan.io"),testnet:!0},n(43).data={name:"Kovan",...o("https://kovan.etherscan.io"),testnet:!0},n(137).data={name:"Matic",...o("https://polygonscan.com")},n(43114).data={name:"Avax C-chain",...o("https://snowtrace.io")};async function a(e,t){let r=3;for(;;)try{return await e(t)}catch(e){if(!(h(e)&&r-- >0))throw e;await new Promise((e=>setTimeout(e,500)))}}async function c({smart:e=!0,timeout:t=3e3}={}){return new Promise(((r,i)=>{let s,n;const o="ethereum#initialized";function h(){let t=globalThis.ethereum;if(t)return r(e?u(t):t),!0}h()||(s=setTimeout((()=>{globalThis?.removeEventListener(o,n),h()||i(new Error("No window.ethereum"))}),0|t),n=()=>{clearTimeout(s),globalThis?.removeEventListener(o,n),h()||i(new Error("jebaited"))},globalThis?.addEventListener(o,n))}))}function u(e){if(e.isSmartProvider)return e;if("function"!=typeof e.request)throw new TypeError("expected provider");const t=e.isMetaMask?"MetaMask":"Unknown Provider";let r;async function i(t){return"eth_chainId"===t.method&&r?r:a(e.request.bind(e),t)}async function s(e,...t){return i({method:e,params:t})}return e.on("connect",(({chainId:e})=>{r=e})),e.on("chainChanged",(e=>{r=e})),e.on("disconnect",(()=>{r=void 0})),new Proxy(e,{get:function(e,n){switch(n){case"req":return s;case"request":return i;case"chain_id":return r;case"source":return t;case"isSmartProvider":return!0;case"disconnect":return e[n]??(()=>{});default:return e[n]}}})}class d{constructor(){this.queue=[]}add_static(e,t){let r=n(e);return t=u(t),this.queue.some((e=>e.provider===t))||this.queue.push({chain:r,provider:t}),this}add_dynamic(e){return e=u(e),this.queue.some((t=>t.provider===e))||this.queue.unshift({provider:e}),this}available_providers(){return this.queue.map((({chain:e,provider:t})=>{if(null==e&&(e=i(t.chain_id)),e)return[e,t]})).filter((e=>e))}disconnect(){for(let{provider:e}of this.queue)e.disconnect?.()}async find_provider(e,t){let r=i(e,t);if(r)for(let{provider:e,chain:t}of this.queue)if(void 0===t&&(t=i(await e.request({method:"eth_chainId"}))),r===t)return e;if(t)throw new Error(`No provider for chain ${r}`)}view(e){let t=n(e),r=async e=>this.find_provider(t,e);return new Proxy(this,{get:(e,i)=>{switch(i){case"isProviderView":return!0;case"chain":return t;case"get_provider":return r;default:return e[i]}}})}}class _ extends class{constructor(){this.__events={}}emit(e,...t){let r=this.__events[e];if(!r)return!1;for(let e of r)e(...t);return!0}on(e,t){let r=this.__events[e];return r||(this.__events[e]=r=[]),r.push(t),this}removeListener(e,t){let r=this.__events[e];if(r){let i=r.indexOf(t);i>=0&&(r.splice(i,1),0==r.length&&delete this.__events[e])}return this}}{get isSmartProvider(){return!0}async req(e,...t){return this.request({method:e,params:[...t]})}}class l extends _{constructor({url:e,fetch:t,source:r,request_timeout:i=3e4,idle_timeout:s=6e4}){if("string"!=typeof e)throw new TypeError("expected url");if(!t){let e=globalThis.fetch;if(!e)throw new TypeError("unable to find fetch()");t=e.bind(globalThis)}super(),this.url=e,this._fetch_api=t,this._id=0,this._chain_id=void 0,this._request_timeout=0|i,this._idle_timeout=0|s,this._idle_timer=void 0,this._source=r}get source(){return this._source??this.url}async request(e){if("object"!=typeof e)throw new TypeError("expected object");let t=this._request_once.bind(this);if(!this._idle_timer){try{this._chain_id=await a(t,{method:"eth_chainId"})}catch(e){throw this.emit("connect-error",e),e}this.emit("connect",{chainId:this._chain_id}),this._restart_idle()}switch(e.method){case"eth_chainId":return this._chain_id;case"eth_subscribe":case"eth_unsubscribe":throw new Error(`${e.method} not supported by FetchProvider`)}try{let r=await a(t,e);return this._restart_idle(),r}catch(e){throw this._terminate(e),e}}_restart_idle(){clearTimeout(this._idle_timer),this._idle_timer=!(this._idle_timeout>0)||setTimeout((()=>{this._terminate(new Error("Idle timeout"))}),this._idle_timeout)}disconnect(){this._idle_timer&&this._terminate(new Error("Forced disconnect"))}_terminate(e){this.emit("disconnect",e),clearTimeout(this._idle_timer),this._idle_timer=void 0,this._chain_id=void 0}_fetch(e,...t){return this._fetch_api(this.url,{method:"POST",body:JSON.stringify({...e,jsonrpc:"2.0",id:++this._id}),cache:"no-store",...t})}async _request_once(e){let t,r;if(this._request_timeout>0){let r=new AbortController,i=setTimeout((()=>r.abort()),this._request_timeout);try{t=await this._fetch(e,{signal:r.signal})}finally{clearTimeout(i)}}else t=await this._fetch(e);if(200!==t.status)throw new Error(`Fetch failed: ${t.status}`);try{r=await t.json()}catch(e){throw new Error("Invalid provider response: expected json",{cause:e})}let{error:i}=r;if(!i)return r.result;let s=new Error(i.message??"unknown error");throw s.code=i.code,s}}class m extends _{constructor({url:e,WebSocket:t,source:r,request_timeout:i=3e4,idle_timeout:s=6e4}){if("string"!=typeof e)throw new TypeError("expected url");if(t||(t=globalThis.WebSocket),!t)throw new Error("unknown WebSocket implementation");super(),this.url=e,this._ws_api=t,this._request_timeout=i,this._idle_timeout=s,this._idle_timer=void 0,this._ws=void 0,this._terminate=void 0,this._reqs=void 0,this._subs=new Set,this._id=void 0,this._chain_id=void 0,this._source=r}get source(){return this._source??this.url}get idle_timeout(){return this._idle_timeout}set idle_timeout(e){this.idle_timeout=0|e,this._restart_idle()}disconnect(){this._terminate?.(new Error("Forced disconnect"))}_restart_idle(){if(clearTimeout(this._idle_timer),this._idle_timeout>0&&0==this._subs.size&&0==Object.keys(this._reqs).length){const{_terminate:e}=this;this._idle_timer=setTimeout((()=>{e(new Error("Idle timeout"))}),this._idle_timeout)}}async request(e){if("object"!=typeof e)throw new TypeError("expected object");let{method:t,params:r}=e;if("string"!=typeof t)throw new Error("expected method");if(r&&!Array.isArray(r))throw new Error("expected params array");switch(await this.ensure_connected(),t){case"eth_chainId":return this._chain_id;case"eth_subscribe":return this._request(e).then((e=>(this._subs.add(e),clearTimeout(this._idle_timer),e)));case"eth_unsubscribe":return this._request(e).then((e=>(this._subs.delete(r[0]),this._restart_idle(),e)));default:return this._request(e)}}_request(e){const t=++this._id,{_reqs:r,_ws:i,_request_timeout:s}=this;return clearTimeout(this._idle_timer),new Promise(((n,o)=>{let h=s>0?setTimeout((()=>{delete r[t],this._restart_idle(),o(new Error("Timeout"))}),s):void 0;r[t]={timer:h,ful:n,rej:o},i.send(JSON.stringify({jsonrpc:"2.0",id:t,...e}))}))}async ensure_connected(){let{_ws:e}=this;if(Array.isArray(e))return new Promise(((t,r)=>{e.push({ful:t,rej:r})}));if(e)return;const t=this._ws=[],r=new this._ws_api(this.url);try{await new Promise(((e,t)=>{this._terminate=t;let i=setTimeout((()=>t(new Error("Timeout"))),this._request_timeout);r.addEventListener("close",t),r.addEventListener("error",t),r.addEventListener("open",(()=>{r.removeEventListener("error",t),r.removeEventListener("close",t),clearTimeout(i),e()}))}))}catch(e){r.close(),this._ws=void 0,this._terminate=void 0;for(let{rej:r}of t)r(e);throw this.emit("connect-error",e),e}this._ws=r,this._id=0;let i,s=this._reqs={},n=this._terminate=e=>{r.removeEventListener("close",i),r.removeEventListener("error",n),r.close(),this._ws=void 0,this._terminate=void 0,this._reqs=void 0,this._id=void 0,this._chain_id=void 0,this._subs.clear(),clearTimeout(this._idle_timer);for(let{rej:t}of Object.values(s))t(e);this.emit("disconnect",e)};i=()=>n(new Error("Unexpected close")),r.addEventListener("close",i),r.addEventListener("error",n),r.addEventListener("message",(({data:e})=>{let t=JSON.parse(e),{id:r}=t;if(void 0===r){let{method:e,params:{subscription:r,result:i}}=t;this.emit("message",{type:e,data:{subscription:r,result:i}})}else{let e=s[r];if(!e)return;delete s[t.id],clearTimeout(e.timer),this._restart_idle();let{result:i,error:n}=t;if(i)return e.ful(i);let o=new Error(n?.message??"Unknown Error");"code"in n&&(o.code=n.code),e.rej(o)}})),this._chain_id=await this._request({method:"eth_chainId"}),this.emit("connect",{chainId:this._chain_id});for(let{ful:e}of t)e()}}export{l as FetchProvider,d as Providers,m as WebSocketProvider,s as defined_chains,c as determine_window_provider,n as ensure_chain,i as find_chain};
